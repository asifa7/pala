name: Start and Monitor Services

on:
  workflow_dispatch:

jobs:
  monitor:
    runs-on: self-hosted
    steps:
      - name: Start services
        run: |
          echo "Starting services..."
          start "" "C:\scripts\start-services.cmd.cmd"
        shell: cmd

      - name: Wait for services to be up
        shell: powershell
        run: |
          $maxRetries = 5
          $retry = 0
          $success = $false
      
          while ($retry -lt $maxRetries -and -not $success) {
              Write-Host "Checking services (Attempt $($retry + 1))..."
      
              try {
                  $es = Invoke-WebRequest -Uri "https://localhost:9200" -UseBasicParsing -SkipCertificateCheck -Credential (New-Object System.Management.Automation.PSCredential("elastic", (ConvertTo-SecureString "_3Ixrn+I=N6pu_C1IzjW" -AsPlainText -Force)))
                  $kibana = Invoke-WebRequest -Uri "http://localhost:5601/app/home#/" -UseBasicParsing
      
                  if ($es.StatusCode -eq 200 -and $kibana.StatusCode -eq 200) {
                      Write-Host "Both services are up!"
                      $success = $true
                  } else {
                      throw "One or both services not ready"
                  }
              } catch {
                  Write-Host "Services not ready. Retrying..."
                  Start-Sleep -Seconds 10
                  Start-Process "C:\scripts\start-services.cmd.cmd"
              }
      
              $retry++
          }
      
          if (-not $success) {
              throw "Services failed to start after $maxRetries attempts"
          }
      - name: Run FileSystemMonitor
        run: |
          echo "Running FileSystemMonitor.py..."
          python "C:\FileSystemMonitor\FileSystemMonitor.py"
        shell: cmd
