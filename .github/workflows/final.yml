name: Start ES/Kibana and run FileSystemMonitor

on:
  workflow_dispatch:

jobs:
  run-on-self-hosted-windows:
    runs-on: [self-hosted, windows]

    env:
      ES_URL: ${{ secrets.ES_URL || 'https://localhost:9200' }}
      KIBANA_URL: ${{ secrets.KIBANA_URL || 'http://localhost:5601' }}
      ES_USERNAME: ${{ secrets.ES_USERNAME || 'elastic' }}
      ES_PASSWORD: ${{ secrets.ES_PASSWORD || '_3Ixrn+I=N6pu_C1IzjW' }}
      TARGET_SCRIPT_DIR: 'C:\scripts'
      TARGET_SCRIPT: 'C:\scripts\start-services.cmd.cmd'
      PYTHON_SCRIPT: 'C:\FileSystemMonitor\FileSystemMonitor.py'
      POLL_RETRIES: 24
      POLL_INTERVAL_SECONDS: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure start-services.cmd is present
        shell: powershell
        run: |
          $repo = $env:GITHUB_WORKSPACE
          $targetDir = "${{ env.TARGET_SCRIPT_DIR }}"
          $targetScript = "${{ env.TARGET_SCRIPT }}"

          $candidates = @(
            "$repo\scripts\start-services.cmd",
            "$repo\start-services.cmd",
            "$repo\start-services.cmd.cmd"
          )

          if (Test-Path $targetScript) { exit 0 }

          foreach ($p in $candidates) {
            if (Test-Path $p) {
              if (-not (Test-Path $targetDir)) {
                New-Item -Path $targetDir -ItemType Directory -Force | Out-Null
              }
              Copy-Item -Path $p -Destination $targetScript -Force
              exit 0
            }
          }

          Write-Error "start-services.cmd not found."; exit 1

      - name: Launch services script
        shell: powershell
        run: |
          Start-Process -FilePath "cmd.exe" -ArgumentList "/c `"$env:TARGET_SCRIPT`""
          Start-Sleep -Seconds 2

      - name: Poll for Elasticsearch & Kibana (TLS disabled)
        shell: powershell
        run: |
          # Disable TLS certificate validation (safe for local/dev)
          [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }

          $esUrl = $env:ES_URL
          $kbUrl = $env:KIBANA_URL
          $retries = [int]$env:POLL_RETRIES
          $interval = [int]$env:POLL_INTERVAL_SECONDS

          Write-Host "Checking ES and Kibana..."

          $esUp = $false
          $kbUp = $false

          for ($i=0; $i -lt $retries; $i++) {

            try {
              (Invoke-WebRequest -Uri $esUrl -UseBasicParsing -TimeoutSec 10) | Out-Null
              $esUp = $true
            } catch {}

            try {
              (Invoke-WebRequest -Uri $kbUrl -UseBasicParsing -TimeoutSec 10) | Out-Null
              $kbUp = $true
            } catch {}

            if ($esUp -and $kbUp) { break }

            Start-Sleep -Seconds $interval
          }

          if (-not ($esUp -and $kbUp)) {
            Write-Warning "ES/Kibana not fully ready â€” continuing anyway."
          }

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies (if any)
        shell: powershell
        run: |
          if (Test-Path "requirements.txt") {
            python -m pip install --upgrade pip
            python -m pip install -r requirements.txt
          }

      - name: Run FileSystemMonitor
        shell: powershell
        run: |
          python "${{ env.PYTHON_SCRIPT }}"
