name: Start ES/Kibana and run FileSystemMonitor

on:
  workflow_dispatch:

jobs:
  run-on-self-hosted-windows:
    runs-on: [self-hosted, windows]

    env:
      ES_URL: 'https://localhost:9200'
      KIBANA_URL: 'http://localhost:5601'
      ES_USERNAME: 'elastic'
      ES_PASSWORD: '_3Ixrn+I=N6pu_C1IzjW'
      PYTHON_SCRIPT: 'C:\FileSystemMonitor\FileSystemMonitor.py'
      POLL_RETRIES: 24
      POLL_INTERVAL_SECONDS: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Disable TLS validation globally (optional)
        shell: powershell
        run: |
          [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }
          Write-Host "TLS validation disabled for job."

      - name: Search ES/Kibana batch files
        shell: powershell
        run: |
          $root = 'C:\asif pala'
          if (-not (Test-Path $root)) { $root = 'C:\' }

          $es = Get-ChildItem -Path $root -Filter 'elasticsearch.bat' -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
          $kb = Get-ChildItem -Path $root -Filter 'kibana.bat' -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName

          Write-Host "elasticsearch.bat => $es"
          Write-Host "kibana.bat       => $kb"

          if ($es) { "ES_BAT=$es" | Out-File -FilePath $env:GITHUB_ENV -Append }
          if ($kb) { "KIB_BAT=$kb" | Out-File -FilePath $env:GITHUB_ENV -Append }

      - name: Start Elasticsearch (even if broken, optional)
        shell: powershell
        run: |
          if (-not $env:ES_BAT) {
            Write-Warning "Elasticsearch bat not found — skipping"
            exit 0
          }
          Start-Process "cmd.exe" "/c `"$env:ES_BAT`"" -WindowStyle Hidden
          Write-Host "Elasticsearch start issued (ignoring health)."

      - name: Start Kibana (required)
        shell: powershell
        run: |
          if (-not $env:KIB_BAT) {
            Write-Error "Kibana bat NOT found — cannot continue."
            exit 1
          }
          Start-Process "cmd.exe" "/c `"$env:KIB_BAT`"" -WindowStyle Hidden
          Write-Host "Kibana start issued."

      - name: Poll ONLY Kibana (Elasticsearch ignored)
        shell: powershell
        run: |
          $url = $env:KIBANA_URL
          $retries = [int]$env:POLL_RETRIES
          $interval = [int]$env:POLL_INTERVAL_SECONDS

          Write-Host "Polling ONLY Kibana at $url..."

          for ($i=1; $i -le $retries; $i++) {
            Write-Host "Attempt $i/$retries..."

            try {
              $resp = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10 -ErrorAction Stop
              Write-Host "Kibana OK: HTTP $($resp.StatusCode)"
              Write-Host "Kibana is UP — continuing."
              break
            }
            catch {
              Write-Host "Kibana not ready: $($_.Exception.Message)"
            }

            Start-Sleep -Seconds $interval
          }

          # After retries, if still not up → fail
          try {
            $test = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 5 -ErrorAction Stop
            Write-Host "Kibana confirmed UP."
          }
          catch {
            Write-Error "Kibana NEVER became available. Stopping workflow."
            exit 1
          }

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run FileSystemMonitor Python script
        shell: powershell
        run: |
          $py = $env:PYTHON_SCRIPT
          if (-not (Test-Path $py)) {
            Write-Error "Python script not found at $py"
            exit 1
          }
          Write-Host "Running Python script..."
          & python $py
