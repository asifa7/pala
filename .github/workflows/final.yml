name: Start ES/Kibana and run FileSystemMonitor

on:
  workflow_dispatch:

jobs:
  run-on-self-hosted-windows:
    runs-on: [self-hosted, windows]

    env:
      ES_URL: 'https://localhost:9200'
      KIBANA_URL: 'http://localhost:5601'
      ES_USERNAME: 'elastic'
      ES_PASSWORD: '_3Ixrn+I=N6pu_C1IzjW'
      PYTHON_SCRIPT: 'C:\FileSystemMonitor\FileSystemMonitor.py'
      POLL_RETRIES: 24
      POLL_INTERVAL_SECONDS: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Disable TLS validation globally (optional)
        shell: powershell
        run: |
          [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }
          Write-Host "TLS validation disabled for job."

      - name: Find Elasticsearch and Kibana batch files (search & report)
        shell: powershell
        run: |
          # prefer searching under C:\asif pala if present to speed up search
          $searchRoot = 'C:\asif pala'
          if (-not (Test-Path $searchRoot)) { $searchRoot = 'C:\' }

          Write-Host "Searching for elasticsearch.bat and kibana.bat under: $searchRoot"
          $esBatPath = Get-ChildItem -Path $searchRoot -Filter 'elasticsearch.bat' -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
          $kibBatPath = Get-ChildItem -Path $searchRoot -Filter 'kibana.bat' -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName

          Write-Host "elasticsearch.bat => $esBatPath"
          Write-Host "kibana.bat       => $kibBatPath"

          if (-not $esBatPath) { Write-Warning "elasticsearch.bat not found under $searchRoot" }
          if (-not $kibBatPath) { Write-Warning "kibana.bat not found under $searchRoot" }

          # Export to job environment file for later steps
          if ($esBatPath) { "`nES_BAT=$esBatPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8 }
          if ($kibBatPath) { "`nKIB_BAT=$kibBatPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8 }

      - name: Start Elasticsearch if found (detached)
        shell: powershell
        run: |
          if (-not $env:ES_BAT) {
            Write-Warning "ES batch path not set; skipping ES start step."
            exit 0
          }
          $esBat = $env:ES_BAT
          Write-Host "Starting Elasticsearch from: $esBat"
          Start-Process -FilePath "cmd.exe" -ArgumentList "/c `"$esBat`"" -WindowStyle Hidden
          Start-Sleep -Seconds 4
          Write-Host "Elasticsearch start command issued."

      - name: Start Kibana if found (detached)
        shell: powershell
        run: |
          if (-not $env:KIB_BAT) {
            Write-Warning "Kibana batch path not set; skipping Kibana start step."
            exit 0
          }
          $kibBat = $env:KIB_BAT
          Write-Host "Starting Kibana from: $kibBat"
          Start-Process -FilePath "cmd.exe" -ArgumentList "/c `"$kibBat`"" -WindowStyle Hidden
          Start-Sleep -Seconds 4
          Write-Host "Kibana start command issued."

      - name: Poll for Elasticsearch & Kibana (verbose)
        shell: powershell
        run: |
          $esUrl = $env:ES_URL
          $kbUrl = $env:KIBANA_URL
          $retries = [int]$env:POLL_RETRIES
          $interval = [int]$env:POLL_INTERVAL_SECONDS

          Write-Host "Polling ES=$esUrl  Kibana=$kbUrl (max $retries attempts, $interval sec interval)"
          $esUp = $false
          $kbUp = $false

          for ($i=0; $i -lt $retries; $i++) {
            Write-Host ""
            Write-Host ("Attempt {0}/{1}" -f ($i+1), $retries)

            try {
              $esResp = Invoke-WebRequest -Uri $esUrl -UseBasicParsing -TimeoutSec 10 -ErrorAction Stop
              Write-Host ("Elasticsearch: HTTP " + $esResp.StatusCode)
              $esUp = $true
            } catch {
              Write-Host ("Elasticsearch check failed: " + $_.Exception.Message)
              $esUp = $false
            }

            try {
              $kbResp = Invoke-WebRequest -Uri $kbUrl -UseBasicParsing -TimeoutSec 10 -ErrorAction Stop
              Write-Host ("Kibana: HTTP " + $kbResp.StatusCode)
              $kbUp = $true
            } catch {
              Write-Host ("Kibana check failed: " + $_.Exception.Message)
              $kbUp = $false
            }

            if ($esUp -and $kbUp) {
              Write-Host "Both services reachable. Continuing."
              break
            }

            Write-Host ("Waiting {0} seconds before next attempt..." -f $interval)
            Start-Sleep -Seconds $interval
          }

          if (-not ($esUp -and $kbUp)) {
            Write-Warning "Timeout waiting for ES/Kibana. Workflow will continue but python script may fail."
          }

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies (if requirements.txt exists)
        shell: powershell
        run: |
          if (Test-Path "requirements.txt") {
            Write-Host "Installing Python dependencies"
            python -m pip install --upgrade pip
            python -m pip install -r requirements.txt
          } else {
            Write-Host "No requirements.txt found - skipping pip install"
          }

      - name: Run FileSystemMonitor Python script
        shell: powershell
        run: |
          $pyScript = "${{ env.PYTHON_SCRIPT }}"
          if (-not (Test-Path $pyScript)) {
            Write-Error "Python script not found at $pyScript; aborting."
            exit 1
          }
          Write-Host "Running Python script: $pyScript"
          & python $pyScript
